<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Remote performance monitor</title>
    <script src="vendor/chart.js"></script>
  </head>

  <style>
    html,
    body {
      height: 95%;
      font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
        sans-serif;
    }

    .item {
      display: grid;
      grid-template-columns: 200px 100px auto;
      grid-column-gap: 15px;
      justify-items: center;
      align-items: center;
      min-width: 0;
      min-height: 0;
      border-radius: 5px;
      background: whitesmoke;
      box-shadow: 0px 0px 10px lightgray;
      border-left: #0d47a1 solid 7px;
    }

    h1,
    h2 {
      margin: 10px;
      text-align: center;
      font-size: 4vh;
    }

    h2 {
      font-size: 3vh;
    }

    canvas {
      max-height: 90%;
      max-width: 100%;
    }

    body {
      display: grid;
      grid-template-rows: auto;
      grid-row-gap: 15px;
    }

    .time {
      grid-template-columns: 1fr 1fr;
      background: lightgrey;
    }
  </style>

  <body>
    <div class="item time">
      <h1 id="time">0</h1>
      <h1 id="date">0</h1>
    </div>
    <div class="item">
      <h2></h2>
      <h1></h1>
      <canvas id="CPU usage"></canvas>
    </div>
    <div class="item">
      <h2></h2>
      <h1></h1>
      <canvas id="CPU temperature"></canvas>
    </div>
    <div class="item">
      <h2></h2>
      <h1></h1>
      <canvas id="GPU usage"></canvas>
    </div>
    <div class="item">
      <h2></h2>
      <h1></h1>
      <canvas id="GPU temperature"></canvas>
    </div>
    <div class="item">
      <h2></h2>
      <h1></h1>
      <canvas id="Framerate"></canvas>
    </div>
  </body>

  <script>
    // CONSTANTS
    const DATA_HISTORY = 20; // Number of old values to keep on charts
    const UPDATE_RATE = 1000; // Update rate in ms

    // Finds current time and date, formats it properly
    function startTime() {
      let now = new Date();
      document.getElementById("date").innerHTML = now.toLocaleString(
        navigator.userLanguage,
        { weekday: "long", year: "numeric", month: "long", day: "numeric" }
      );
      document.getElementById("time").innerHTML = now.toLocaleString(
        navigator.userLanguage,
        { hour: "2-digit", minute: "2-digit", second: "2-digit" }
      );
      let t = setTimeout(startTime, 500);
    }

    // Start time
    startTime();

    // Create labels array
    let n = -1 * DATA_HISTORY;
    let labels = [];
    while (n <= 0) {
      labels.push(n);
      n++;
    }

    // Create charts
    const canvasArray = document.getElementsByTagName("canvas");
    let chartArray = [];
    for (let i = 0; i < canvasArray.length; i++) {
      chartArray.push(CreateChart(canvasArray.item(i)));
    }

    // Update charts every interval (ms)
    setInterval(Update, UPDATE_RATE);

    function Update() {
      fetch("/api", {
        method: "get"
      })
        .then(response => response.json())
        .then(dataObjectArray => {
          for (let i = 0; i < chartArray.length; i++) {
            dataObject = dataObjectArray.find(
              x => x.SrcName === chartArray[i].id
            );
            UpdateChart(chartArray[i], dataObject);
          }
        })
        .catch(err => console.log(err));
    }

    // CreateChart creates a chart and returns an handle to the create chart
    function CreateChart(canvas) {
      const ctx = canvas.getContext("2d");
      return {
        id: canvas.id,
        chart: new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                borderColor: `rgb(${getRandomInt(255)}, ${getRandomInt(
                  255
                )}, ${getRandomInt(255)})`,
                data: [],
                fill: false,
                borderWidth: 10,
                pointRadius: 0
              }
            ]
          },
          options: {
            legend: {
              display: false
            },
            animation: {
              duration: UPDATE_RATE / 5
            },
            scales: {
              xAxes: [
                {
                  gridLines: {
                    display: false,
                    drawBorder: false
                  },
                  ticks: {
                    display: false
                  }
                }
              ],
              yAxes: [
                {
                  gridLines: {
                    display: false,
                    drawBorder: false
                  },
                  ticks: {
                    display: false,
                    suggestedMin: 0,
                    suggestedMax: 100
                  }
                }
              ]
            }
          }
        })
      };
    }

    function UpdateChart(chartObject, dataObject) {
      // Update counter
      document
        .getElementById(chartObject.id)
        .parentNode.getElementsByTagName("h2")[0].innerHTML =
        dataObject.LocalizedSrcName;
      document
        .getElementById(chartObject.id)
        .parentNode.getElementsByTagName("h1")[0].innerHTML =
        dataObject.Data.toFixed(0) + " " + dataObject.LocalizedSrcUnits;
      // Update chart
      let dataArray = chartObject.chart.data.datasets[0].data;
      if (dataArray.length >= DATA_HISTORY + 1) {
        dataArray.splice(0, 1);
      }
      dataArray.push(dataObject.Data);
      chartObject.chart.update();
    }

    function getRandomInt(max) {
      return Math.floor(Math.random() * Math.floor(max));
    }
  </script>
</html>
